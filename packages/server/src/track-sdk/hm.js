!function(e){"use strict";class t{constructor(){this.queue=[],this.taskHandle=null}push(e){this.queue.push(e),this.run()}run(){const e=t=>{for(;(t.timeRemaining()>0||t.didTimeout)&&this.queue.length;)this.queue.shift()?.();this.queue.length&&(this.taskHandle=requestIdleCallback(e,{timeout:1e3}))};this.taskHandle=requestIdleCallback(e,{timeout:1e3})}}const n=e=>{window.addEventListener("load",(function(){new PerformanceObserver((t=>{const n=t.getEntriesByType("navigation")[0];if(n instanceof PerformanceNavigationTiming){const t=n;let o=0;o=t.startTime;const s=[{key:"Redirect",desc:"网页重定向的耗时",value:t.redirectEnd-t.redirectStart},{key:"AppCache",desc:"检查本地缓存的耗时",value:t.domainLookupStart-t.fetchStart},{key:"DNS",desc:"DNS查询的耗时",value:t.domainLookupEnd-t.domainLookupStart},{key:"TCP",desc:"TCP连接的耗时",value:t.connectEnd-t.connectStart},{key:"Waiting(TTFB)",desc:"从客户端发起请求到接收到响应的时间 / Time To First Byte",value:t.responseStart-t.requestStart},{key:"Content Download",desc:"下载服务端返回数据的时间",value:t.responseEnd-t.responseStart},{key:"HTTP Total Time",desc:"http请求总耗时",value:t.responseEnd-t.requestStart},{key:"DOMContentLoaded",desc:"dom加载完成的时间",value:t.domContentLoadedEventEnd-o},{key:"Loaded",desc:"页面load的总耗时",value:t.loadEventEnd-o}];if(Math.random()>.75){const n=window.location,a=n.href,r=n.pathname,i=navigator.userAgent,c=a.split("?")[0];e.post("basicInfo",{app:"shakespeare-performance",url:c,ua:i,path:r,basicInfo:s,stats_ttfb:t.responseStart-t.requestStart,stats_domLoaded:t.domContentLoadedEventEnd-o,stats_loaded:t.loadEventEnd-o})}console&&console.log&&console.log(s)}})).observe({entryTypes:["navigation"]})}))},o=e=>{window.addEventListener("error",(t=>{const n=t.target,o=n.getAttribute("src"),s=n.getAttribute("href"),a=o||s;console.log("出错了",t),a?e.post("/error/asset",{type:"resource",message:`${a} is load error`,reason:t.message}):e.post("/error/simple",{type:"resource",message:t.message})}),!0),window.addEventListener("unhandledrejection",(t=>{console.log("异步错误",t.reason),e.post("/error/async",{type:"unhandledrejection",message:t.reason})}),!0)},s=e=>{const t=history[e];return function(...n){const o=t.apply(this,n),s=new Event(e);return window.dispatchEvent(s),o}},a=e=>{window.addEventListener("hashchange",(t=>{const n=t.newURL,o=t.oldURL;e.post("/route/hashchange",{type:"hashchange",newUrl:n,oldUrl:o})})),window.trackerHistory=()=>{window.history.pushState=s("pushState"),window.history.replaceState=s("replaceState");["pushState","replaceState","popstate"].forEach((t=>{window.addEventListener(t,(n=>{const o=window.location.href;console.log(n),e.post("/route/change",{type:t,newUrl:o})}))}))}};class r{constructor(e){this.BASE_URL=e.requestURL,this.id=e.id,this.plugins=e.plugins??[],this.flush=new t,this.init()}init(){this.plugins?.some((e=>e(this)))}reportTracker(e){const t=Object.assign({},e,{time:new Date}),n=new Blob([JSON.stringify(t)],{type:"text/plain"});navigator.sendBeacon(`${this.BASE_URL}/tracker`,n)}post(e,t){this.flush.push((()=>{this.reportTracker({type:e,data:t})}))}}(async()=>{const e=(e=>e.split("?")[1])(document.querySelectorAll("script")[0].src);if(void 0===e)console.error("无id");else{window.requestIdleCallback=window.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})}),1)},window.cancelIdleCallback=window.cancelIdleCallback||function(e){clearTimeout(e)};const t="http://localhost:4000",s=await fetch(`${t}/site/${e}`);switch((await s.json()).code){case 404:console.error("错误的id");break;case 403:console.error("该id与注册网址不符合");break;case 200:console.log("启用埋点"),window.tracker=new r({id:e,requestURL:t,plugins:[n,o,a]})}}})(),e.Tracker=r}({});
